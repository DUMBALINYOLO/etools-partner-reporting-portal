<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-file/etools-file.html">

<link rel="import" href="../../endpoints.html">
<link rel="import" href="../../behaviors/utils.html">
<link rel="import" href="../../behaviors/notifications.html">
<link rel="import" href="../../redux/store.html">
<link rel="import" href="../../redux/actions/pdReportsAttachments.html">
<link rel="import" href="../../redux/selectors/programmeDocumentReportsAttachments.html">
<link rel="import" href="../etools-prp-ajax.html">

<dom-module id="report-attachments">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <etools-prp-ajax
        id="upload"
        method="put"
        url="[[attachmentsUrl]]">
    </etools-prp-ajax>

    <etools-prp-ajax
        id="download"
        method="get"
        url="[[attachmentsListUrl]]">
    </etools-prp-ajax>

    <etools-prp-ajax
        id="delete"
        method="delete"
        url="[[attachmentDeleteUrl]]">
    </etools-prp-ajax>

    <etools-file
        files="{{attachments}}"
        label="Attachments"
        file-types="[[fileTypes]]"
        disabled="[[pending]]"
        readonly="[[readonly]]"
        file-model="[[fileModel]]"
        multiple
        activate-file-types
        use-delete-events>
    </etools-file>
  </template>

  <script>
    Polymer({
      is: 'report-attachments',

      behaviors: [
        App.Behaviors.UtilsBehavior,
        App.Behaviors.ReduxBehavior,
        App.Behaviors.NotificationsBehavior,
      ],

      listeners: {
        'delete-file': '_onDeleteFile',
      },

      properties: {
        readonly: Boolean,

        fileTypes: {
          type: Array,
          value: [
            {
              "id": 3,
              "name": "FACE"
            },
            {
              "id": 4,
              "name": "Other"
            }
          ],
          notify: true
        },

        fileModel: {
          type: Object,
          value: {
            id: null,
            file_name: null,
            path: null,
            size: null,
            raw: null,
            type: null
          },
          notify: true
        },

        pending: {
          type: Boolean,
          statePath: App.Selectors.ProgrammeDocumentReportsAttachments.pending,
        },

        attachments: {  
          type: Array,
          statePath: App.Selectors.ProgrammeDocumentReportsAttachments.current,
        },

        attachmentsListUrl: {
          type: String,
          computed: '_computeListUrl(locationId, reportId)',
        },

        attachmentDeleteUrl: {
          type: String
        },

        locationId: {
          type: String,
          statePath: 'location.id',
        },

        reportId: {
          type: String,
          statePath: 'programmeDocumentReports.current.id',
        },
      },

      observers: [
        '_filesChanged(attachments.*)',
      ],

      _computeListUrl: function (locationId, reportId) {
        return App.Endpoints.progressReportAttachments(locationId, reportId);
      },

      _getDeleteUrl: function (locationId, reportId, attachmentId) {
        return App.Endpoints.progressReportAttachmentDetail(locationId, reportId, attachmentId);
      },

      _onDeleteFile: function (e) {
        var self = this;
        var deleteThunk;
        var deleteUrl = self._getDeleteUrl(self.locationId, self.reportId, e.detail.file.id);

        this.set('attachmentDeleteUrl', deleteUrl);

        e.stopPropagation();

        deleteThunk = this.$.delete.thunk();

        this.$.delete.abort();

        this.dispatch(
          App.Actions.PDReportsAttachments.sync(deleteThunk, this.reportId)
        )
            .then(function () {
              self._notifyFileDeleted();
              this.set('attachmentDeleteUrl', undefined);
            })
            .catch(function (err) { // jshint ignore:line
              // TODO: error handling
            });
      },

      _filesChanged: function (change) {
        console.log('hellooooooo');
        console.log(change);

        // Loop through and find the file that null raw
        // if path null and raw undefined, use that file and exit loop
        // if replacing existing file, if path is defined and has a raw, that's the one to replace
        // create file and pass down to debounce

        this.debounce('files-changed', function () {
          var file = this.files[0];
          var self = this;
          var uploadThunk;
          var data;

          if (change.path.split('.').length < 2 || !file) {
            return;
          }

          uploadThunk = this.$.upload.thunk();

          this.$.upload.abort();

          data = new FormData();

          if (file) {
            data.append('path', file.raw, file.file_name);
          }

          this.$.upload.body = data;

          this.dispatch(
            App.Actions.PDReportsAttachments.sync(uploadThunk, this.reportId)
          )
              .then(function () {
                self._notifyFileUploaded();
              })
              .catch(function (err) { // jshint ignore:line
                // TODO: error handling
              });
        });
      },

      attached: function () {
        var downloadThunk = this.$.download.thunk();

        this.$.download.abort();

        this.dispatch(
          App.Actions.PDReportsAttachments.sync(downloadThunk, this.reportId)
        )
            .catch(function (err) { // jshint ignore:line
              // TODO: error handling
            });
      },

      detached: function () {
        [
          this.$.download,
          this.$.upload,
          this.$.delete,
        ].forEach(function (req) {
          req.abort();
        });

        if (this.isDebouncerActive('files-changed')) {
          this.cancelDebouncer('files-changed');
        }
      },
    });
  </script>
</dom-module>
