<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/etools-file/etools-file.html">

<link rel="import" href="../../endpoints.html">
<link rel="import" href="../../behaviors/utils.html">
<link rel="import" href="../../behaviors/notifications.html">
<link rel="import" href="../../redux/store.html">
<link rel="import" href="../../redux/actions/pdReportsAttachments.html">
<link rel="import" href="../../redux/selectors/programmeDocumentReportsAttachments.html">
<link rel="import" href="../etools-prp-ajax.html">

<dom-module id="report-attachments">
  <template>
    <style>
      :host {
        display: block;
      }
    </style>

    <etools-prp-ajax
        id="upload"
        method="post"
        loading="{{loading}}"
        url="[[attachmentsListUrl]]">
    </etools-prp-ajax>
    
    <template is="dom-if" if="{{loading}}">
      <paper-spinner active></paper-spinner>
    </template>

    <etools-prp-ajax
        id="replace"
        method="put"
        url="[[attachmentDeleteUrl]]">
    </etools-prp-ajax>

    <etools-prp-ajax
        id="download"
        method="get"
        url="[[attachmentsListUrl]]">
    </etools-prp-ajax>

    <etools-prp-ajax
        id="delete"
        method="delete"
        url="[[attachmentDeleteUrl]]">
    </etools-prp-ajax>

    <etools-file
        id="faceAttachmentComponent"
        files="{{faceAttachment}}"
        label="FACE"
        disabled="[[pending]]"
        readonly="[[readonly]]"
        use-delete-events>
    </etools-file>

    <etools-file
        id="otherOneAttachmentComponent"
        files="{{otherOneAttachment}}"
        label="Other #1"
        disabled="[[pending]]"
        readonly="[[readonly]]"
        use-delete-events>
    </etools-file>

    <etools-file
        id="otherTwoAttachmentComponent"
        files="{{otherTwoAttachment}}"
        label="Other #2"
        disabled="[[pending]]"
        readonly="[[readonly]]"
        use-delete-events>
    </etools-file>

  </template>

  <script>
    Polymer({
      is: 'report-attachments',

      behaviors: [
        App.Behaviors.UtilsBehavior,
        App.Behaviors.ReduxBehavior,
        App.Behaviors.NotificationsBehavior,
      ],

      listeners: {
        'delete-file': '_onDeleteFile',
      },

      properties: {
        readonly: Boolean,

        faceAttachment: {
          type: Array,
        },

        otherOneAttachment: {
          type: Array,
        },

        otherTwoAttachment: {
          type: Array,
        },

        pending: {
          type: Boolean,
          statePath: App.Selectors.ProgrammeDocumentReportsAttachments.pending,
        },

        attachments: {
          type: Array,
          statePath: App.Selectors.ProgrammeDocumentReportsAttachments.current,
          observer: '_setFiles',
        },

        attachmentsListUrl: {
          type: String,
          computed: '_computeListUrl(locationId, reportId)',
        },

        attachmentDeleteUrl: {
          type: String
        },

        locationId: {
          type: String,
          statePath: 'location.id',
        },

        reportId: {
          type: String,
          statePath: 'programmeDocumentReports.current.id',
        },
      },

      observers: [
        '_filesChanged(faceAttachment.*)',
        '_filesChanged(otherOneAttachment.*)',
        '_filesChanged(otherTwoAttachment.*)',
      ],

      _computeListUrl: function (locationId, reportId) {
        return App.Endpoints.progressReportAttachments(locationId, reportId);
      },

      _setFiles: function (attachments) {
        var self = this;
        this.set('faceAttachment', []);
        this.set('otherOneAttachment', []);
        this.set('otherTwoAttachment', []);

        attachments.forEach(function(attachment) {
          if (attachment && !attachment.path) {
            return;
          }
          if (attachment.type === 'FACE') {
            self.set('faceAttachment', [attachment]);
          }
          if (attachment.type === 'Other') {
            if (self.get('otherOneAttachment').length === 0) {
              self.set('otherOneAttachment', [attachment]);
             } else {
               self.set('otherTwoAttachment', [attachment]);
             }
          }
        });
      },

      _getDeleteUrl: function (locationId, reportId, attachmentId) {
        return App.Endpoints.progressReportAttachmentDetail(locationId, reportId, attachmentId);
      },

      _onDeleteFile: function (e) {
        var self = this;
        var deleteThunk;
        var deleteUrl = self._getDeleteUrl(self.locationId, self.reportId, e.detail.file.id);

        this.set('attachmentDeleteUrl', deleteUrl);

        e.stopPropagation();

        deleteThunk = this.$.delete.thunk();

        this.$.delete.abort();

        this.dispatch(
          App.Actions.PDReportsAttachments.sync(deleteThunk, this.reportId)
        )
            .then(function () {
              self._notifyFileDeleted();
              self.set('attachmentDeleteUrl', undefined);

              if (self.get('faceAttachment').length !== 0 && e.detail.file.id === self.get('faceAttachment')[0].id) {
                self.$.faceAttachmentComponent.fileInput.value = null;
                self.$.faceAttachmentComponent.set('files', []);
              } else if (self.get('otherOneAttachment').length !== 0
                && e.detail.file.id === self.get('otherOneAttachment')[0].id) {
                self.$.otherOneAttachmentComponent.fileInput.value = null;
                self.$.otherOneAttachmentComponent.set('files', []);
              } else if (self.get('otherTwoAttachment').length !== 0
                && e.detail.file.id === self.get('otherTwoAttachment')[0].id) {
                self.$.otherTwoAttachmentComponent.fileInput.value = null;
                self.$.otherTwoAttachmentComponent.set('files', []);
              }
            })
            .catch(function (err) { // jshint ignore:line
              // TODO: error handling
            });
      },

      _filesChanged: function (change) {
        var attachmentPropertyName = change.path.replace('.length', '');
        var isEmpty = change.value === 0 ? true : false;
        var attachment = isEmpty ? undefined : change.base[0];
        var self = this;

        if (attachment === undefined) {
          return;
        }

        var files = isEmpty ? [] : change.base;

        var attachmentType = attachmentPropertyName.toLowerCase().indexOf('face') !== -1 ? 'FACE' : 'Other';

        if (isEmpty || (!isEmpty && attachment.path !== null)) {
          return;
        }

        this.debounce('files-changed', function () {
          var thunk;
          var data;

          if (change.path.split('.').length < 2 || !files.length) {
            return;
          }

          data = new FormData();

          files.forEach(function(file) {
            data.append('path', file.raw, file.file_name);
            data.append('type', attachmentType);
          });

          if (attachment.id === null) {
            thunk = this.$.upload.thunk();
            this.$.upload.abort();
            this.$.upload.body = data;
          } else {
            var replaceUrl = self._getDeleteUrl(self.locationId, self.reportId, attachment.id);
            this.set('attachmentDeleteUrl', replaceUrl);

            thunk = this.$.replace.thunk();
            this.$.replace.abort();
            this.$.replace.body = data;

            attachmentPropertyName = attachmentPropertyName.split('.')[0];
          }

          this.dispatch(
            App.Actions.PDReportsAttachments.sync(thunk, this.reportId)
          )
            .then(function () {
              self._notifyFileUploaded();
              var attachments = self.get('attachments');

              attachments.forEach(function(item) {
                if (attachment.id !== null && item.id === attachment.id) {
                  self.set(attachmentPropertyName, [item]);
                  return;
                }
              });

              if (attachment.id === null) {
                var duplicates = attachments.filter(function(item) {
                  var tokens = attachment.file_name.split('.');
                  if (tokens.length === 0) {
                    return item.file_name.indexOf(attachment.file_name) !== -1;
                  } else {
                    return item.file_name.indexOf(tokens[0]) !== -1;
                  }
                });

                if (duplicates.length === 1) {
                  self.set(attachmentPropertyName, [duplicates[0]]);
                } else {
                  var correctedItem;

                  duplicates.forEach(function(item) {
                    if (item.file_name !== attachment.file_name) {
                      correctedItem = item;
                      return;
                    }
                  });

                  self.set(attachmentPropertyName, [correctedItem]);
                }
              }

              self.set('attachmentDeleteUrl', undefined);
            })
            .catch(function (err) { // jshint ignore:line
              console.log(err);
              // TODO: error handling
            });
        });
      },

      attached: function () {
        var downloadThunk = this.$.download.thunk();

        this.$.download.abort();

        this.dispatch(
          App.Actions.PDReportsAttachments.sync(downloadThunk, this.reportId)
        )
            .catch(function (err) { // jshint ignore:line
              // TODO: error handling
            });
      },

      detached: function () {
        [
          this.$.download,
          this.$.upload,
          this.$.delete,
        ].forEach(function (req) {
          req.abort();
        });

        if (this.isDebouncerActive('files-changed')) {
          this.cancelDebouncer('files-changed');
        }
      },
    });
  </script>
</dom-module>
