version: '2.1'

services:
  beater-prp:
    command: bash -c "/usr/local/bin/waitforit -host=db -port=5432 && celery -A django_api beat -l ${CELERY_LOG_LEVEL:-info} --scheduler django_celery_beat.schedulers:DatabaseScheduler -b $REDIS_URL"
    image: 'unicef/etools-prp:local'
    env_file:
      - .env
    depends_on:
      - django_api
      - prp-redis
    restart: always
    volumes:
      - './django_api:/code/'

  worker-prp:
    command: bash -c "/usr/local/bin/waitforit -host=db -port=5432 && celery -A django_api worker -l ${CELERY_LOG_LEVEL:-info} -b $REDIS_URL"
    image: 'unicef/etools-prp:local'
    env_file:
      - .env
    depends_on:
      - django_api
      - prp-redis
    restart: always
    volumes:
      - './django_api:/code/'

  id-management-frontend:
    image: unicef/etools-prp-id-management-frontend
    build:
      context: ./react/id_management_frontend
      dockerfile: ./Dockerfile
    volumes:
      - ./react/id_management_frontend/:/code
      - /code/node_modules
    command: bash -c "npm start"
    labels:
      - "traefik.http.routers.id-management-frontend.rule=PathPrefix(`/id-management`)"
      - traefik.http.routers.id-management-frontend.service=id-management-frontend
      - traefik.http.routers.id-management-frontend.middlewares=id-management-frontend-stripprefix
      - traefik.http.middlewares.id-management-frontend-stripprefix.stripprefix.prefixes=/id-management
      - traefik.http.services.id-management-frontend.loadBalancer.server.port=3000
      - traefik.enable=true

  polymer:
    image: unicef/etools-prp-polymer_3
    build:
      context: ./polymer_3
      dockerfile: ./Dockerfile-dev
    volumes:
        - ./polymer_3/:/code
    command: ash -c "npm run dev"
    labels:
      - "traefik.http.routers.polymer.rule=PathPrefix(`/`)"
      - traefik.http.routers.polymer.service=polymer
      - traefik.http.services.polymer.loadBalancer.server.port=8082
      - traefik.enable=true
